<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Promoter Tools | Brum Out Loud</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Anton&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="/css/main.css">
    <script src="/js/main.js" defer></script>
</head>
<body class="antialiased">

    <div id="header-placeholder"></div>

    <main class="container mx-auto px-8 py-16">
        <section class="max-w-4xl mx-auto">
            <div class="text-center mb-16">
                <h1 class="font-anton text-7xl md:text-8xl leading-none tracking-wider heading-gradient">PROMOTER <span class="accent-color">TOOLS</span></h1>
                <p class="mt-4 text-xl text-gray-300 max-w-2xl mx-auto">Choose the best way to add your events to BrumOutLoud. All submissions are reviewed by our team before going live.</p>
            </div>

            <div class="space-y-8">
                <div class="card-bg p-8 md:p-12">
                    <h2 class="font-anton text-3xl text-white">1. Add a Single Event</h2>
                    <p class="text-gray-400 mt-2 mb-6"><b>Best for:</b> One-off events or if you only have a few to add.</p>
                    <a href="/promoter-submit.html" class="bg-accent-color text-white font-bold py-3 px-8 rounded-lg hover:opacity-90 transition-opacity inline-block">Use Simple Form</a>
                </div>

                <div class="card-bg p-8 md:p-12">
                     <h2 class="font-anton text-3xl text-white">2. Submit a Poster</h2>
                     <p class="text-gray-400 mt-2 mb-6"><b>Best for:</b> When you already have a promotional flyer or poster image.</p>
                    <form id="poster-form" class="space-y-6">
                        <div>
                            <label for="poster-file" class="block text-sm font-semibold mb-2 accent-color-secondary">Upload Poster Image</label>
                            <input type="file" id="poster-file" name="poster" class="w-full text-sm text-gray-400 file:mr-4 file:py-3 file:px-4 file:rounded-lg file:border-0 file:font-semibold file:bg-gray-700 file:text-white hover:file:bg-gray-600" accept="image/png, image/jpeg, image/gif" required>
                        </div>
                        <div id="image-preview" class="hidden"><img id="preview-img" class="rounded-lg max-h-64 mx-auto" alt="Image preview"></div>
                        <div class="pt-4"><button type="submit" class="bg-accent-color text-white font-bold py-3 px-8 rounded-lg w-full flex items-center justify-center">Parse Poster</button></div>
                    </form>
                </div>

                <div class="card-bg p-8 md:p-12">
                    <h2 class="font-anton text-3xl text-white">3. Submit in Bulk</h2>
                    <p class="text-gray-400 mt-2 mb-6"><b>Best for:</b> Submitting a whole season of events or many listings at once.</p>
                    <form id="bulk-upload-form" class="space-y-6">
                        <div>
                            <label for="spreadsheet-file" class="block text-sm font-semibold mb-2 accent-color-secondary">Upload Spreadsheet (.csv, .xlsx)</label>
                            <input type="file" id="spreadsheet-file" name="spreadsheet" class="w-full text-sm text-gray-400 file:mr-4 file:py-3 file:px-4 file:rounded-lg file:border-0 file:font-semibold file:bg-gray-700 file:text-white hover:file:bg-gray-600" accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel" required>
                        </div>
                        <div class="pt-6"><button type="submit" class="bg-accent-color text-white font-bold py-3 px-8 rounded-lg hover:opacity-90 w-full flex items-center justify-center">
                            <span id="bulk-submit-text">Parse Spreadsheet</span>
                            <span id="bulk-submit-loader" class="loader ml-3 w-5 h-5 border-2 hidden"></span>
                        </button></div>
                    </form>
                </div>
            </div>
            
            <div class="mt-12 text-center card-bg p-8">
                 <h3 class="font-anton text-2xl text-white">After You Submit with Poster or Spreadsheet</h3>
                 <p class="text-gray-400 mt-2">Our smart system will parse the details from your file. You will then be asked to review and approve the extracted information before it is sent to our team for final approval.</p>
            </div>

            <div id="status-message" class="mt-8 text-center text-lg font-semibold hidden"></div>
            <div id="results-container" class="mt-8 space-y-6"></div>
        </section>
    </main>

    <div id="footer-placeholder"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const posterForm = document.getElementById('poster-form');
            const bulkUploadForm = document.getElementById('bulk-upload-form');
            const fileInput = document.getElementById('poster-file');
            const imagePreviewContainer = document.getElementById('image-preview');
            const previewImg = document.getElementById('preview-img');
            const resultsContainer = document.getElementById('results-container');
            const statusMessage = document.getElementById('status-message');
            const VALID_CATEGORIES = ["Comedy", "Drag", "Live Music", "Men Only", "Party", "Pride", "Social", "Theatre", "Viewing Party", "Women Only", "Fetish", "Community", "Exhibition", "Health", "Quiz"];

            if(fileInput) {
                fileInput.addEventListener('change', () => {
                    const file = fileInput.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => { previewImg.src = e.target.result; imagePreviewContainer.classList.remove('hidden'); };
                        reader.readAsDataURL(file);
                    }
                });
            }

            function renderEventForm(eventData, index) {
                const categoryOptions = VALID_CATEGORIES.map(cat => {
                    const isSelected = (Array.isArray(eventData.categories) && eventData.categories.includes(cat));
                    return `<option value="${cat}" ${isSelected ? 'selected' : ''}>${cat}</option>`;
                }).join('');

                const formHtml = `
                    <form class="event-review-form card-bg p-6 space-y-4" data-index="${index}">
                        <h3 class="font-anton text-2xl text-white">Review Event ${index + 1}</h3>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div><label class="block text-sm font-semibold mb-1 accent-color-secondary">Name</label><input type="text" name="name" value="${eventData.name || ''}" class="w-full p-2 bg-gray-900/50 rounded-md"></div>
                            <div><label class="block text-sm font-semibold mb-1 accent-color-secondary">Venue</label><input type="text" name="venue" value="${eventData.venue || ''}" class="w-full p-2 bg-gray-900/50 rounded-md"></div>
                        </div>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div><label class="block text-sm font-semibold mb-1 accent-color-secondary">Date</label><input type="date" name="date" value="${eventData.date || ''}" class="w-full p-2 bg-gray-900/50 rounded-md"></div>
                            <div><label class="block text-sm font-semibold mb-1 accent-color-secondary">Time (24hr)</label><input type="time" name="time" value="${eventData.time || ''}" class="w-full p-2 bg-gray-900/50 rounded-md"></div>
                        </div>
                        <div><label class="block text-sm font-semibold mb-1 accent-color-secondary">Description</label><textarea name="description" rows="3" class="w-full p-2 bg-gray-900/50 rounded-md">${eventData.description || ''}</textarea></div>
                        <div class="flex justify-end gap-4 pt-2">
                            <button type="button" class="reject-btn bg-red-600/20 text-red-300 font-bold py-2 px-4 rounded-lg">Reject</button>
                            <button type="submit" class="approve-btn bg-green-600/20 text-green-300 font-bold py-2 px-4 rounded-lg">Submit for Final Review</button>
                        </div>
                    </form>
                `;
                resultsContainer.insertAdjacentHTML('beforeend', formHtml);
            }

            async function handleFormSubmit(formElement, endpoint) {
                const submitBtn = formElement.querySelector('button[type=submit]');
                const originalBtnContent = submitBtn.innerHTML;
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="loader w-5 h-5 border-2"></span><span class="ml-2">Processing...</span>';
                
                resultsContainer.innerHTML = '';
                statusMessage.textContent = 'Contacting our smart system... This may take a moment.';
                statusMessage.classList.remove('hidden');

                try {
                    const formData = new FormData(formElement);
                    const response = await fetch(endpoint, { method: 'POST', body: formData });
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.message || 'An unknown server error occurred.');
                    
                    statusMessage.textContent = `Smart system found ${result.events.length} event(s). Please review the details below.`;
                    if(result.events.length === 0) { statusMessage.textContent = "Could not find any clear event details in the file."; }
                    
                    const encodedData = btoa(JSON.stringify(result.events));
                    window.location.href = `/admin-review#${encodedData}`;

                } catch (error) {
                    statusMessage.textContent = `Error: ${error.toString()}`;
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnContent;
                }
            }

            if(posterForm) {
                posterForm.addEventListener('submit', (e) => { 
                    e.preventDefault(); 
                    handleFormSubmit(posterForm, '/.netlify/functions/process-poster'); 
                });
            }

            if(bulkUploadForm) {
                bulkUploadForm.addEventListener('submit', (e) => { 
                    e.preventDefault(); 
                    handleFormSubmit(bulkUploadForm, '/.netlify/functions/process-spreadsheet'); 
                });
            }
        });
    </script>
</body>
</html>
