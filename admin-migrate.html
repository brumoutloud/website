<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Migration Tool</title>
    <link rel="stylesheet" href="/css/main.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loader {
            border: 4px solid #333;
            border-top: 4px solid #B564F7;
            border-radius: 50%;
            width: 1.5rem;
            height: 1.5rem;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="antialiased">
    <main class="container mx-auto px-8 py-16 text-center max-w-2xl">
        <h1 class="font-anton text-5xl text-white mb-4">Data Migration Tool</h1>
        <p class="text-gray-400 mb-8">Use this tool to scrape events from the live brumoutloud.co.uk site and import them into the Airtable database.</p>
        
        <div class="card-bg p-8">
            <button id="start-migration-btn" class="nav-cta w-full text-lg flex items-center justify-center">
                Start Event Migration
            </button>
            <div id="status-container" class="mt-6 text-left hidden">
                 <p id="status-message" class="font-semibold text-lg"></p>
                 <div id="log-output" class="mt-2 text-left bg-gray-900/50 p-4 rounded-lg text-gray-400 text-sm whitespace-pre-wrap max-h-64 overflow-y-auto"></div>
            </div>
        </div>
    </main>

    <script>
        const startBtn = document.getElementById('start-migration-btn');
        const statusContainer = document.getElementById('status-container');
        const statusMessage = document.getElementById('status-message');
        const logOutput = document.getElementById('log-output');

        startBtn.addEventListener('click', async () => {
            startBtn.disabled = true;
            startBtn.innerHTML = '<span class="loader"></span><span class="ml-3">Migration in Progress...</span>';
            statusContainer.classList.remove('hidden');
            logOutput.innerHTML = '<p class="text-gray-400">> Starting migration...</p>';

            try {
                // **FIX:** Calling our single, unified migration function
                const response = await fetch('/.netlify/functions/migrate-data', { 
                    method: 'POST',
                    headers: { 'Accept': 'application/json' }
                });
                
                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.message || `Server responded with status ${response.status}`);
                }

                statusMessage.textContent = 'Migration Complete!';
                logOutput.innerHTML = `<p class="text-green-400">> ${result.message}</p>`;
                startBtn.style.backgroundColor = '#10B981';
                startBtn.innerHTML = 'Complete!';

            } catch (error) {
                statusMessage.textContent = 'Migration Failed';
                logOutput.innerHTML = `<p class="text-red-400">> ${error.toString()}</p>`;
                startBtn.disabled = false;
                startBtn.innerHTML = 'Try Again';
            }
        });
    </script>
</body>
</html>
