<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pending Approvals | Brum Out Loud</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Anton&family=Poppins:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="/css/main.css">
    <script type="module" src="/js/auth-guard.js"></script>
    <style>
        /* Add any specific styles for this page here if needed */
        .approval-card {
            background-color: #1e1e1e;
            border: 1px solid #2e2e2e;
            border-radius: 0.75rem;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .approval-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #2e2e2e;
            padding-bottom: 0.75rem;
            margin-bottom: 0.75rem;
        }
        .approval-card-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }
        .approval-card-detail-item p {
            font-size: 0.875rem;
            color: #d1d5db;
        }
        .approval-card-actions {
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
            margin-top: 1rem;
        }
        .approval-card-actions button {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .button-approve { background-color: #10B981; color: white; } /* Green */
        .button-approve:hover { background-color: #059669; }
        .button-reject { background-color: #EF4444; color: white; } /* Red */
        .button-reject:hover { background-color: #DC2626; }
        .button-edit { background-color: #3B82F6; color: white; } /* Blue */
        .button-edit:hover { background-color: #2563EB; }
    </style>
</head>
<body class="antialiased">

    <div id="header-placeholder"></div>

    <main class="container mx-auto px-8 py-8 relative z-10">
        <section class="max-w-4xl mx-auto">

            <!-- Breadcrumb Start -->
            <nav class="flex mb-8" aria-label="Breadcrumb">
                <ol role="list" class="flex items-center space-x-4">
                    <li>
                        <a href="admin-settings.html" class="text-sm font-medium text-gray-400 hover:text-white">Admin Panel</a>
                    </li>
                    <li>
                        <div class="flex items-center">
                            <i class="fas fa-chevron-right fa-xs text-gray-500 flex-shrink-0" aria-hidden="true"></i>
                            <span aria-current="page" class="ml-4 text-sm font-medium text-white">
                                Pending Approvals
                            </span>
                        </div>
                    </li>
                </ol>
            </nav>
            <!-- Breadcrumb End -->

            <div class="text-center mb-16">
                <h1 class="font-anton text-7xl md:text-8xl leading-none tracking-wider heading-gradient">PENDING <span class="accent-color">APPROVALS</span></h1>
                <p class="mt-4 text-xl text-gray-300 max-w-2xl mx-auto">Review user-submitted events and venues before they go live on the site.</p>
            </div>
            
            <div id="loading-state" class="text-center py-10">
                <div class="loader inline-block"></div>
                <p class="mt-4 text-gray-400">Loading pending items...</p>
            </div>

            <div id="approval-list" class="space-y-6"></div>
            <div id="no-items-message" class="hidden text-center card-bg p-12">
                <div class="mx-auto h-16 w-16 flex items-center justify-center rounded-full bg-gray-800 text-green-400"><i class="fas fa-check-circle fa-2x"></i></div>
                <h3 class="mt-4 text-xl font-semibold text-white">All Caught Up!</h3>
                <p class="mt-2 text-gray-400">There are no pending submissions to review.</p>
            </div>
        </section>
    </main>

    <div id="edit-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden">
        <form id="edit-form" class="card-bg p-8 w-full max-w-3xl space-y-4 max-h-[90vh] overflow-y-auto">
             <h3 class="font-anton text-3xl text-white">Edit Event Submission</h3>
             <div id="edit-form-fields" class="space-y-4"></div>
             <div class="flex justify-end gap-4 pt-4">
                 <button type="button" id="cancel-edit-btn" class="bg-gray-700 text-white font-bold py-2 px-6 rounded-lg">Cancel</button>
                 <button type="submit" class="bg-accent-color text-white font-bold py-2 px-6 rounded-lg">Save Changes</button>
             </div>
        </form>
    </div>

    <div id="rejection-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden">
        <div class="card-bg p-8 w-full max-w-lg">
            <h3 class="font-anton text-3xl text-white mb-4">Reason for Rejection</h3>
            <p class="text-gray-400 mb-6">This will be sent to the promoter if they provided an email. Keep it brief and helpful.</p>
            <textarea id="rejection-reason" rows="4" class="w-full p-3 bg-gray-900/50 rounded-lg border border-gray-700"></textarea>
            <div class="flex justify-end gap-4 mt-6">
                <button id="cancel-rejection-btn" class="bg-gray-700 text-white font-bold py-2 px-6 rounded-lg">Cancel</button>
                <button id="confirm-rejection-btn" class="bg-red-600 text-white font-bold py-2 px-6 rounded-lg">Confirm Rejection</button>
            </div>
        </div>
    </div>
    
    <div id="footer-placeholder"></div>

    <script src="/js/main.js" defer></script>
    <script>
        const approvalList = document.getElementById('approval-list');
        const loadingState = document.getElementById('loading-state');
        const noItemsMessage = document.getElementById('no-items-message');
        const editModal = document.getElementById('edit-modal');
        const editForm = document.getElementById('edit-form');
        const editFormFields = document.getElementById('edit-form-fields');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const rejectionModal = document.getElementById('rejection-modal');
        const rejectionReasonInput = document.getElementById('rejection-reason');
        const cancelRejectionBtn = document.getElementById('cancel-rejection-btn');
        const confirmRejectionBtn = document.getElementById('confirm-rejection-btn');
        
        const VALID_CATEGORIES = ["Comedy", "Drag", "Live Music", "Men Only", "Party", "Pride", "Social", "Theatre", "Viewing Party", "Women Only", "Fetish", "Community", "Exhibition", "Health", "Quiz"];
        let currentItemForAction = null; 
        let allVenues = []; 

        function showStatusMessage(message, isError = false) {
            const statusDiv = document.getElementById('status-message');
            if (!statusDiv) { 
                console.log('Status: ' + message);
                return;
            }
            statusDiv.textContent = message;
            statusDiv.classList.remove('hidden', 'text-green-400', 'text-red-400');
            statusDiv.classList.add(isError ? 'text-red-400' : 'text-green-400');
            setTimeout(() => statusDiv.classList.add('hidden'), 5000);
        }

        function renderItem(item) {
            const fields = item.fields;
            let title = fields['Event Name'];
            const eventDate = new Date(fields['Date']);
            const formattedDate = eventDate.toLocaleDateString('en-GB', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });
            const venueName = fields['Venue Name'] && fields['Venue Name'].length > 0 ? fields['Venue Name'][0] : (fields['VenueText'] || 'Venue TBC');
            const categories = fields['Category'] ? fields['Category'].join(', ') : 'None';
            const imageUrl = fields['Promo Image'] && fields['Promo Image'].length > 0 ? fields['Promo Image'][0].url : 'https://placehold.co/100x100/1e1e1e/EAEAEA?text=No+Image';

            const card = document.createElement('div');
            card.className = 'approval-card';
            card.dataset.id = item.id;
            card.dataset.type = item.type; 
            card.innerHTML = `
                <div class="approval-card-header">
                    <h3 class="text-xl font-bold text-white">${title} <span class="text-sm text-gray-400 ml-2">(Event)</span></h3>
                    <img src="${imageUrl}" alt="${title}" class="w-16 h-16 object-cover rounded-md">
                </div>
                <div class="approval-card-details">
                    <div class="approval-card-detail-item"><p class="font-bold">Date:</p><p>${formattedDate}</p></div>
                    <div class="approval-card-detail-item"><p class="font-bold">Venue:</p><p>${venueName}</p></div>
                    <div class="approval-card-detail-item"><p class="font-bold">Categories:</p><p>${categories}</p></div>
                    <div class="approval-card-detail-item"><p class="font-bold">Description:</p><p>${fields['Description'] || 'N/A'}</p></div>
                    ${fields['Link'] ? `<div class="approval-card-detail-item"><p class="font-bold">Link:</p><p><a href="${fields['Link']}" target="_blank" class="text-blue-400 hover:underline">View</a></p></div>` : ''}
                    ${fields['Recurring Info'] ? `<div class="approval-card-detail-item"><p class="font-bold">Recurring:</p><p>${fields['Recurring Info']}</p></div>` : ''}
                    ${fields['Contact Email'] ? `<div class="approval-card-detail-item"><p class="font-bold">Submitter Email:</p><p>${fields['Contact Email']}</p></div>` : ''}
                </div>
                <div class="approval-card-actions">
                    <button class="button-edit" data-action="edit">Edit</button>
                    <button class="button-reject" data-action="reject">Reject</button>
                    <button class="button-approve" data-action="approve">Approve</button>
                </div>
            `;
            return card;
        }

        async function loadPendingItems() {
            loadingState.classList.remove('hidden');
            approvalList.innerHTML = ''; 
            noItemsMessage.classList.add('hidden');

            try {
                const response = await fetch('/.netlify/functions/get-pending-items');
                if (!response.ok) throw new Error('Failed to fetch pending items.');
                
                const items = await response.json();
                
                loadingState.classList.add('hidden');

                if (items && items.length > 0) {
                    items.forEach(item => {
                        approvalList.appendChild(renderItem(item));
                    });
                } else {
                    noItemsMessage.classList.remove('hidden');
                }
            } catch (error) {
                console.error("Error loading pending items:", error);
                loadingState.innerHTML = `<p class="text-red-400 text-center">Failed to load pending items: ${error.message}</p>`;
                loadingState.classList.remove('hidden');
            }
        }

        function populateEditForm(item) {
            console.log('Populating edit form for item:', item);
            editModal.classList.remove('hidden'); 

            editFormFields.innerHTML = '';

            const fields = item.fields;
            const currentCategories = fields.Category || [];
            const categoryCheckboxes = VALID_CATEGORIES.map(cat => `<label class="inline-flex items-center gap-2"><input type="checkbox" name="Category" value="${cat}" ${currentCategories.includes(cat) ? 'checked' : ''} class="form-checkbox h-5 w-5 rounded bg-gray-700 border-gray-600 text-accent-color focus:ring-accent-color"><span class="text-white">${cat}</span></label>`).join('');

            const eventDate = fields['Date'] ? new Date(fields['Date']).toISOString().split('T')[0] : '';
            const eventTime = fields['Date'] ? new Date(fields['Date']).toTimeString().substring(0, 5) : '';
            const venueId = fields.Venue && fields.Venue.length > 0 ? fields.Venue[0] : '';
            const venueText = fields.VenueText || '';
            const currentPromoImageUrl = fields['Promo Image'] && fields['Promo Image'].length > 0 ? fields['Promo Image'][0].url : '';

            const eventNameDiv = document.createElement('div');
            eventNameDiv.innerHTML = `<label>Event Name</label><input type="text" name="Event Name" value="${fields['Event Name'] || ''}" required>`;
            editFormFields.appendChild(eventNameDiv);

            const contactEmailDiv = document.createElement('div');
            contactEmailDiv.innerHTML = `<label>Submitter Email</label><input type="email" name="Submitter Email" value="${fields['Submitter Email'] || fields['Contact Email'] || ''}" placeholder="Contact email if available">`;
            editFormFields.appendChild(contactEmailDiv);

            const venueSelectDiv = document.createElement('div');
            const venueSelectLabel = document.createElement('label');
            venueSelectLabel.textContent = 'Venue';
            venueSelectDiv.appendChild(venueSelectLabel);

            const venueSelect = document.createElement('select');
            venueSelect.name = 'venueId';
            venueSelect.classList.add('venue-select');
            venueSelect.innerHTML = `<option value="">-- Select or Add Venue --</option>` +
                                      allVenues.map(venue => `<option value="${venue.id}">${venue.name}</option>`).join('') +
                                      `<option value="__CREATE_NEW__">-- Add a new unlisted venue --</option>`;
            venueSelectDiv.appendChild(venueSelect);
            editFormFields.appendChild(venueSelectDiv);

            const newVenueFields = document.createElement('div');
            newVenueFields.id = 'new-venue-fields';
            newVenueFields.classList.add('hidden', 'space-y-2', 'p-4', 'mt-2', 'bg-gray-800', 'rounded-lg');
            newVenueFields.innerHTML = `
                <label class="font-semibold text-white">New Venue Name</label>
                <input type="text" id="new-venue-name" name="new-venue-name" placeholder="New Venue Name" class="w-full p-2 bg-gray-900/50 rounded-md border border-gray-700 text-white">
                <label class="font-semibold text-white">New Venue Address</label>
                <input type="text" id="new-venue-address" name="new-venue-address" placeholder="New Venue Address" class="w-full p-2 bg-gray-900/50 rounded-md border border-gray-700 text-white">
            `;
            editFormFields.appendChild(newVenueFields);

            if (venueId) {
                venueSelect.value = venueId;
            } else if (venueText) {
                venueSelect.value = '__CREATE_NEW__';
                newVenueFields.querySelector('#new-venue-name').value = venueText;
            }

            venueSelect.addEventListener('change', () => {
                const showNew = venueSelect.value === '__CREATE_NEW__';
                newVenueFields.classList.toggle('hidden', !showNew);
                newVenueFields.querySelectorAll('input').forEach(input => input.required = showNew);
            });
            newVenueFields.classList.toggle('hidden', venueSelect.value !== '__CREATE_NEW__');
            newVenueFields.querySelectorAll('input').forEach(input => input.required = (venueSelect.value === '__CREATE_NEW__'));


            const dateTimeDiv = document.createElement('div');
            dateTimeDiv.classList.add('grid', 'md:grid-cols-2', 'gap-4');
            dateTimeDiv.innerHTML = `
                <div><label>Date</label><input type="date" name="date" value="${eventDate}" required></div>
                <div><label>Time (24hr)</label><input type="time" name="time" value="${eventTime}" required></div>
            `;
            editFormFields.appendChild(dateTimeDiv);

            const descriptionDiv = document.createElement('div');
            descriptionDiv.innerHTML = `<label>Description</label><textarea name="Description" rows="4">${fields['Description'] || ''}</textarea>`;
            editFormFields.appendChild(descriptionDiv);

            const linkDiv = document.createElement('div');
            linkDiv.innerHTML = `<label>Ticket Link</label><input type="url" name="Link" value="${fields['Link'] || ''}" placeholder="https://">`;
            editFormFields.appendChild(linkDiv);

            const recurringDiv = document.createElement('div');
            recurringDiv.innerHTML = `<label>Recurring Info (Optional)</label><input type="text" name="Recurring Info" value="${fields['Recurring Info'] || ''}" placeholder="e.g., Every Thursday">`;
            editFormFields.appendChild(recurringDiv);

            const promoImageDiv = document.createElement('div');
            promoImageDiv.innerHTML = `
                <label for="promo-image-file" class="block text-sm font-semibold mb-2 accent-color-secondary">Promo Image</label>
                <input type="file" id="promo-image-file" name="promo-image" class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-gray-700 file:text-white hover:file:bg-gray-600" accept="image/png, image/jpeg, image/webp">
                ${currentPromoImageUrl ? `<p class="text-xs text-gray-500 mt-1">Current image: <a href="${currentPromoImageUrl}" target="_blank" class="text-blue-400 hover:underline">View</a></p>` : ''}
            `;
            editFormFields.appendChild(promoImageDiv);

            const categoriesDiv = document.createElement('div');
            categoriesDiv.classList.add('border-t', 'border-gray-700', 'pt-4');
            categoriesDiv.innerHTML = `<label>Categories</label><div class="grid grid-cols-2 md:grid-cols-3 gap-2 mt-2 p-3 rounded-md border border-gray-700">${categoryCheckboxes}</div>`;
            editFormFields.appendChild(categoriesDiv);

            editFormFields.querySelectorAll('input:not([type=checkbox]):not([type=file]), textarea, select').forEach(el => el.className = 'w-full p-2 bg-gray-900/50 rounded-md border border-gray-700 text-white');
            editFormFields.querySelectorAll('label').forEach(el => el.className = 'block text-sm font-semibold mb-1 accent-color-secondary');
        }

        editForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitBtn = editForm.querySelector('button[type=submit]');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Saving...';

            let venueId = null;
            const venueSelect = editFormFields.querySelector('.venue-select');
            if (venueSelect) {
                venueId = venueSelect.value;
                if (venueId === '__CREATE_NEW__') {
                    const newVenueName = editFormFields.querySelector('#new-venue-name').value;
                    const newVenueAddress = editFormFields.querySelector('#new-venue-address').value;
                    if (!newVenueName || !newVenueAddress) {
                        showStatusMessage('Please provide a name and address for the new venue.', true);
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Save Changes';
                        return;
                    }
                    try {
                        const response = await fetch('/.netlify/functions/create-unlisted-venue', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ venueName: newVenueName, address: newVenueAddress })
                        });
                        const result = await response.json();
                        if (!result.success) throw new Error(result.message);
                        venueId = result.id;
                    } catch (error) {
                        showStatusMessage(`Error creating new venue: ${error.message}`, true);
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Save Changes';
                        return;
                    }
                }
            }

            const formData = new FormData(editForm);
            formData.append('id', currentItemForAction.id);
            formData.append('type', 'Event');

            if (venueId) {
                formData.set('venueId', venueId);
            } else {
                formData.delete('venueId');
            }
            
            try {
                const response = await fetch('/.netlify/functions/update-submission', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.message || 'Server error');

                showStatusMessage('Submission updated successfully!', false);
                editModal.classList.add('hidden');
                loadPendingItems();
            } catch (error) {
                showStatusMessage(`Error updating submission: ${error.message}`, true);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Save Changes';
            }
        });

        approvalList.addEventListener('click', async (e) => {
            const button = e.target.closest('button');
            if (!button) {
                console.log('Clicked, but not a button or child of button.');
                return;
            }

            const card = e.target.closest('.approval-card');
            if (!card) {
                console.log('Clicked button is not within an approval card.');
                return;
            }
            console.log('Button clicked:', button.dataset.action, 'on card ID:', card.dataset.id, 'type:', card.dataset.type);

            try {
                const endpoint = '/.netlify/functions/get-event-details-by-id'; // FIX: Use the new function for ID-based fetch
                console.log(`Fetching details for Event ID: ${card.dataset.id} from ${endpoint}`);
                const response = await fetch(`${endpoint}?id=${card.dataset.id}`); 
                const fetchedItem = await response.json();

                if (!response.ok || !fetchedItem || !fetchedItem.fields) {
                    throw new Error(fetchedItem.message || 'Failed to fetch event details.');
                }
                currentItemForAction = {
                    id: card.dataset.id,
                    type: 'Event',
                    fields: fetchedItem.fields
                };
                console.log('Fetched item details for action:', currentItemForAction);

            } catch (error) {
                console.error('Error fetching item details:', error);
                showStatusMessage(`Error loading item details: ${error.message}`, true);
                return;
            }

            const action = button.dataset.action;
            console.log('Performing action:', action);

            if (action === 'edit') {
                populateEditForm(currentItemForAction);
                return;
            }

            const actionStatus = action === 'approve' ? 'Approved' : 'Rejected';
            let rejectionReason = '';

            if (action === 'reject') {
                rejectionModal.classList.remove('hidden');
                const handleCancelRejection = () => {
                    rejectionModal.classList.add('hidden');
                    rejectionReasonInput.value = '';
                    cancelRejectionBtn.removeEventListener('click', handleCancelRejection);
                    confirmRejectionBtn.removeEventListener('click', handleConfirmRejection);
                };
                const handleConfirmRejection = async () => {
                    rejectionReason = rejectionReasonInput.value;
                    rejectionModal.classList.add('hidden');
                    rejectionReasonInput.value = '';
                    cancelRejectionBtn.removeEventListener('click', handleCancelRejection);
                    confirmRejectionBtn.removeEventListener('click', handleConfirmRejection);
                    await updateItemStatus(currentItemForAction.id, currentItemForAction.type, actionStatus, rejectionReason);
                };
                cancelRejectionBtn.addEventListener('click', handleCancelRejection);
                confirmRejectionBtn.addEventListener('click', handleConfirmRejection);
            } else {
                await updateItemStatus(currentItemForAction.id, currentItemForAction.type, actionStatus);
            }
        });

        async function updateItemStatus(id, type, status, rejectionReason = '') {
            console.log(`Attempting to update status for ${type} ID: ${id} to ${status}`);
            try {
                const response = await fetch('/.netlify/functions/update-item-status', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id, type, status, rejectionReason })
                });

                const result = await response.json();
                console.log('update-item-status response:', result);
                if (!response.ok) throw new Error(result.message || 'Server error');

                showStatusMessage(`${type} ${status} successfully!`, false);
                loadPendingItems();
            } catch (error) {
                console.error('Error in updateItemStatus:', error);
                showStatusMessage(`Error ${status} ${type}: ${error.message}`, true);
            }
        }

        async function loadInitialData() {
            loadingState.classList.remove('hidden');
            try {
                const venuesResponse = await fetch('/.netlify/functions/get-venue-list');
                if (!venuesResponse.ok) throw new Error('Failed to fetch venues for dropdown.');
                allVenues = await venuesResponse.json();
                console.log('Venues loaded for dropdown:', allVenues.length);

                await loadPendingItems();
            } catch (error) {
                console.error("Error during initial data load:", error);
                loadingState.innerHTML = `<p class="text-red-400 text-center">Initialization error: ${error.message}</p>`;
            }
        }

        document.addEventListener('DOMContentLoaded', loadInitialData);
        cancelEditBtn.addEventListener('click', () => editModal.classList.add('hidden'));
    </script>
</body>
</html>
