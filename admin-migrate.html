<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Migration Tool</title>
    <link rel="stylesheet" href="/css/main.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loader {
            border: 4px solid #333;
            border-top: 4px solid #B564F7;
            border-radius: 50%;
            width: 1.5rem;
            height: 1.5rem;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="antialiased">
    <main class="container mx-auto px-8 py-16 text-center max-w-2xl">
        <h1 class="font-anton text-5xl text-white mb-4">Data Migration Tool</h1>
        <p class="text-gray-400 mb-8">Use this tool to import events from the live brumoutloud.co.uk site into the Airtable database.</p>
        
        <div class="card-bg p-8">
            <button id="start-migration-btn" class="nav-cta w-full text-lg flex items-center justify-center">
                Start Event Migration
            </button>
            <div id="status-container" class="mt-6 text-left hidden">
                 <p id="progress-bar-container" class="w-full bg-gray-700 rounded-full h-4 mb-4 hidden"><span id="progress-bar" class="bg-accent-color h-4 rounded-full" style="width: 0%"></span></p>
                 <p id="status-message" class="font-semibold text-lg"></p>
                 <div id="log-output" class="mt-2 text-left bg-gray-900/50 p-4 rounded-lg text-gray-400 text-sm whitespace-pre-wrap max-h-64 overflow-y-auto"></div>
            </div>
        </div>
    </main>

    <script>
        const startBtn = document.getElementById('start-migration-btn');
        const statusContainer = document.getElementById('status-container');
        const statusMessage = document.getElementById('status-message');
        const logOutput = document.getElementById('log-output');
        const progressBarContainer = document.getElementById('progress-bar-container');
        const progressBar = document.getElementById('progress-bar');
        const BASE_URL = 'https://brumoutloud.co.uk';

        function log(message, type = 'info') {
            const color = type === 'error' ? 'text-red-400' : 'text-gray-400';
            logOutput.innerHTML += `<p class="${color}">> ${message}</p>`;
            logOutput.scrollTop = logOutput.scrollHeight;
        }

        startBtn.addEventListener('click', async () => {
            // --- UI SETUP ---
            startBtn.disabled = true;
            startBtn.innerHTML = '<span class="loader"></span><span class="ml-3">Starting...</span>';
            statusContainer.classList.remove('hidden');
            logOutput.innerHTML = '';

            try {
                // --- STEP 1: Get all event URLs ---
                log('Fetching list of event URLs...');
                statusMessage.textContent = 'Step 1 of 2: Getting all event URLs...';
                const urlsResponse = await fetch('/.netlify/functions/get-event-urls', { method: 'POST' });
                const urlsResult = await urlsResponse.json();
                if (!urlsResponse.ok || !urlsResult.success) throw new Error(urlsResult.message || 'Failed to fetch URLs.');
                
                const eventUrls = urlsResult.urls;
                log(`Found ${eventUrls.length} event URLs to process.`);

                // --- STEP 2: Process each URL one by one ---
                statusMessage.textContent = `Step 2 of 2: Processing ${eventUrls.length} events...`;
                progressBarContainer.style.display = 'block';
                let successCount = 0;

                for (let i = 0; i < eventUrls.length; i++) {
                    const eventPath = eventUrls[i];
                    const fullUrl = `${BASE_URL}${eventPath}`;
                    
                    try {
                        const processResponse = await fetch('/.netlify/functions/process-single-event', {
                            method: 'POST',
                            body: JSON.stringify({ eventUrl: fullUrl })
                        });
                        const processResult = await processResponse.json();

                        if (processResult.success) {
                            if(processResult.status === 'created') {
                                log(`SUCCESS: Created "${processResult.name}"`);
                                successCount++;
                            } else {
                                log(`SKIPPED: "${processResult.name}" already exists.`);
                            }
                        } else {
                            log(`FAILED to process ${eventPath}: ${processResult.message}`, 'error');
                        }
                    } catch (e) {
                         log(`CRITICAL FAIL on ${eventPath}: ${e.message}`, 'error');
                    }
                    progressBar.style.width = `${((i + 1) / eventUrls.length) * 100}%`;
                }

                // --- FINAL UI UPDATE ---
                statusMessage.textContent = 'Migration Complete!';
                log(`Finished! Added ${successCount} new events.`);
                startBtn.style.backgroundColor = '#10B981';
                startBtn.innerHTML = 'Complete!';

            } catch (error) {
                statusMessage.textContent = 'Migration Failed';
                log(error.toString(), 'error');
                startBtn.disabled = false;
                startBtn.innerHTML = 'Try Again';
            }
        });
    </script>
</body>
</html>
