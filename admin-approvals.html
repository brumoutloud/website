<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pending Approvals | Brum Out Loud</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Anton&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="/css/main.css">
    <script type="module" src="/js/auth-guard.js"></script>
</head>
<body class="antialiased">

    <header class="p-8">
        <nav class="container mx-auto flex justify-between items-center">
            <a href="/" class="font-anton text-2xl tracking-widest text-white">BRUM OUT LOUD</a>
            <a href="/admin/settings" class="text-gray-300 hover:text-white">Back to Admin Settings</a>
        </nav>
    </header>

    <main class="container mx-auto px-8 py-16">
        <section class="max-w-4xl mx-auto">
            <div class="text-center mb-16">
                <h1 class="font-anton text-7xl md:text-8xl leading-none tracking-wider heading-gradient">PENDING <span class="accent-color">APPROVALS</span></h1>
                <p class="mt-4 text-xl text-gray-300 max-w-2xl mx-auto">Review user-submitted events and venues before they go live on the site.</p>
            </div>
            
            <div id="loading-state" class="text-center py-10">
                <div class="loader inline-block"></div>
                <p class="mt-4 text-gray-400">Loading pending items...</p>
            </div>

            <div id="approval-list" class="space-y-6"></div>
            <div id="no-items-message" class="hidden text-center card-bg p-12">
                <div class="mx-auto h-16 w-16 flex items-center justify-center rounded-full bg-gray-800 text-green-400"><i class="fas fa-check-circle fa-2x"></i></div>
                <h3 class="mt-4 text-xl font-semibold text-white">All Caught Up!</h3>
                <p class="mt-2 text-gray-400">There are no pending submissions to review.</p>
            </div>
        </section>
    </main>

    <div id="edit-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden">
        <form id="edit-form" class="card-bg p-8 w-full max-w-3xl space-y-4 max-h-[90vh] overflow-y-auto">
             <h3 class="font-anton text-3xl text-white">Edit Submission</h3>
             <div id="edit-form-fields" class="space-y-4"></div>
             <div class="flex justify-end gap-4 pt-4">
                 <button type="button" id="cancel-edit-btn" class="bg-gray-700 text-white font-bold py-2 px-6 rounded-lg">Cancel</button>
                 <button type="submit" class="bg-accent-color text-white font-bold py-2 px-6 rounded-lg">Save Changes</button>
             </div>
        </form>
    </div>

    <div id="rejection-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden">
        <div class="card-bg p-8 w-full max-w-lg">
            <h3 class="font-anton text-3xl text-white mb-4">Reason for Rejection</h3>
            <p class="text-gray-400 mb-6">This will be sent to the promoter if they provided an email. Keep it brief and helpful.</p>
            <textarea id="rejection-reason" rows="4" class="w-full p-3 bg-gray-900/50 rounded-lg border border-gray-700"></textarea>
            <div class="flex justify-end gap-4 mt-6">
                <button id="cancel-rejection-btn" class="bg-gray-700 text-white font-bold py-2 px-6 rounded-lg">Cancel</button>
                <button id="confirm-rejection-btn" class="bg-red-600 text-white font-bold py-2 px-6 rounded-lg">Confirm Rejection</button>
            </div>
        </div>
    </div>
    
    <script>
        const approvalList = document.getElementById('approval-list');
        const loadingState = document.getElementById('loading-state');
        const noItemsMessage = document.getElementById('no-items-message');
        const editModal = document.getElementById('edit-modal');
        const editForm = document.getElementById('edit-form');
        const editFormFields = document.getElementById('edit-form-fields');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const rejectionModal = document.getElementById('rejection-modal');
        const rejectionReasonInput = document.getElementById('rejection-reason');
        const cancelRejectionBtn = document.getElementById('cancel-rejection-btn');
        const confirmRejectionBtn = document.getElementById('confirm-rejection-btn');
        
        const VALID_CATEGORIES = ["Comedy", "Drag", "Live Music", "Men Only", "Party", "Pride", "Social", "Theatre", "Viewing Party", "Women Only", "Fetish", "Community", "Exhibition", "Health", "Quiz"];
        let currentItemForAction = null;
        let allVenues = []; // <-- Variable to hold venues for the dropdown

        // (renderItem function remains the same as your provided file)
        function renderItem(item) { /* ... existing code ... */ }

        function populateEditForm(item) {
            currentItemForAction = item;
            const fields = item.fields;
            let formHtml = '';

            if (item.type === 'Event') {
                const currentCategories = fields['Category'] || [];
                const categoryCheckboxes = VALID_CATEGORIES.map(cat => `<label class="inline-flex items-center gap-2"><input type="checkbox" name="Category" value="${cat}" ${currentCategories.includes(cat) ? 'checked' : ''} class="form-checkbox h-5 w-5 rounded bg-gray-700 border-gray-600 text-accent-color focus:ring-accent-color"><span class="text-white">${cat}</span></label>`).join('');
                const eventDate = fields['Date'] ? new Date(fields['Date']).toISOString().split('T')[0] : '';
                const eventTime = fields['Date'] ? new Date(fields['Date']).toTimeString().substring(0, 5) : '';
                
                // --- VENUE FIX START ---
                // Create dropdown options from the pre-fetched venues
                const venueOptionsHtml = allVenues.map(venue => `<option value="${venue.id}">${venue.name}</option>`).join('');

                formHtml = `
                    <div class="grid md:grid-cols-2 gap-4">
                        <div><label>Event Name</label><input type="text" name="Event Name" value="${fields['Event Name'] || ''}"></div>
                        <div>
                            <label>Venue</label>
                            <select name="venueId" class="venue-select w-full p-2 bg-gray-900/50 rounded-md border border-gray-700">
                                <option value="">Select an existing venue...</option>
                                ${venueOptionsHtml}
                                <option value="__CREATE_NEW__">-- Add a new unlisted venue --</option>
                            </select>
                        </div>
                    </div>
                    <div class="hidden space-y-2" id="new-venue-fields">
                        <input type="text" id="new-venue-name" placeholder="New Venue Name" class="w-full p-2 bg-gray-800 rounded-md border border-gray-600">
                        <input type="text" id="new-venue-address" placeholder="New Venue Address" class="w-full p-2 bg-gray-800 rounded-md border border-gray-600">
                    </div>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div><label>Date</label><input type="date" name="date" value="${eventDate}"></div>
                        <div><label>Time (24hr)</label><input type="time" name="time" value="${eventTime}"></div>
                    </div>
                    <div><label>Description</label><textarea name="Description" rows="4">${fields['Description'] || ''}</textarea></div>
                    <div>
                        <label>Categories</label>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-2 mt-2 p-3 rounded-md border border-gray-700">${categoryCheckboxes}</div>
                    </div>
                `;
                // --- VENUE FIX END ---
            } else { 
                // Venue form remains the same
                formHtml = `... existing venue form HTML ...`;
            }

            editFormFields.innerHTML = formHtml;
            // Add styling to new elements
            editFormFields.querySelectorAll('input[type=text], input[type=date], input[type=time], textarea, select').forEach(el => el.className = 'w-full p-2 bg-gray-900/50 rounded-md border border-gray-700');
            editFormFields.querySelectorAll('label').forEach(el => el.className = 'block text-sm font-semibold mb-1 accent-color-secondary');

            // Add event listener for the new dropdown
            const venueSelect = editFormFields.querySelector('.venue-select');
            if (venueSelect) {
                venueSelect.addEventListener('change', () => {
                    const newVenueFields = editFormFields.querySelector('#new-venue-fields');
                    if (venueSelect.value === '__CREATE_NEW__') {
                        newVenueFields.classList.remove('hidden');
                    } else {
                        newVenueFields.classList.add('hidden');
                    }
                });
            }
            editModal.classList.remove('hidden');
        }

        editForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            // --- VENUE FIX: Logic to handle new venue creation before submission ---
            const venueSelect = editForm.querySelector('.venue-select');
            let venueId = venueSelect ? venueSelect.value : null;

            if (venueId === '__CREATE_NEW__') {
                const newVenueName = editForm.querySelector('#new-venue-name').value;
                const newVenueAddress = editForm.querySelector('#new-venue-address').value;
                if (!newVenueName || !newVenueAddress) {
                    alert('Please provide a name and address for the new venue.');
                    return;
                }
                try {
                    const response = await fetch('/.netlify/functions/create-unlisted-venue', { /* ... create venue logic ... */ });
                    const result = await response.json();
                    if (!result.success) throw new Error(result.message);
                    venueId = result.id;
                } catch (error) {
                    alert(`Error creating new venue: ${error.message}`);
                    return;
                }
            }

            // Continue with existing form submission logic, but now using the correct venueId
            const formData = new FormData(editForm);
            formData.append('id', currentItemForAction.id);
            formData.append('type', currentItemForAction.type);
            if (venueId) {
                formData.set('venueId', venueId); // Use .set to override any existing venue field
            }
             
            // The rest of the submission logic...
            const response = await fetch('/.netlify/functions/update-submission', { body: formData, method: 'POST' });
            // ...
        });

        async function loadInitialData() {
            // --- VENUE FIX: Fetch venues first so they are ready for the edit form ---
            try {
                const response = await fetch('/.netlify/functions/get-venue-list');
                if (!response.ok) throw new Error('Could not load venues');
                allVenues = await response.json();
            } catch (error) {
                console.error(error);
                alert('Warning: Could not load venue list for editing.');
            }
            // Now load pending items
            // ... existing loadPendingItems logic ...
        }

        document.addEventListener('DOMContentLoaded', loadInitialData);
        // All other event listeners remain the same
    </script>
</body>
</html>
